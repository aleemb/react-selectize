<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="../bower_components/selectize/dist/css/selectize.css" />
    <link rel="stylesheet" href="../bower_components/selectize/dist/css/selectize.default.css" />

    <style>
        .control-group {
            width: 200px;
        }
    </style>

    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="../bower_components/selectize/dist/js/standalone/selectize.js"></script>

    <script src="../react-0.10.0/build/react.js"></script>
    <script src="../react-0.10.0/build/JSXTransformer.js"></script>
</head>
<body>
  <!--view-->
  <div id="example"></div>

  <!--code-->
  <script type="text/jsx">
    /** @jsx React.DOM */

    var CountryService = {
      getCountryList: function () {
        return [
          { name: "Russia", id: 1},
          { name: "Brazil", id: 2},
          { name: "Spain", id: 3},
        ];
      }
    };

    var CityService = {
      _data: {
        1: [
          { name: "Moscow", id: 1 },
          { name: "St.Petersburg", id: 2 },
          { name: "Smolensk", id: 3 },
        ],
        2: [
          { name: "Rio de Janeiro", id: 4 },
          { name: "Sao Paulo", id: 5 },
          { name: "Santa Catarina", id: 6}
        ],
        3: [
          { name: "Madrid", id: 7 },
          { name: "Salamanca", id: 8 },
          { name: "Zaragoza", id: 9 }
        ]
      },

      getCitiesByCountryId: function (countryId) {
        return this._data[countryId].slice();
      }
    };

    var SightsService = {
      _data: [
        { id: 1, cityId: 7, name: "Gran Via" },
        { id: 2, cityId: 7, name: "El Escorial" },
        { id: 3, cityId: 1, name: "Kremlin" },
        { id: 4, cityId: 2, name: "Petergof" },
        { id: 5, cityId: 4, name: "Cristo Redentor" },
        { id: 6, cityId: 5, name: "Credicard Hall" },
      ],

      getSightsByCityId: function (id) {
        return this._data.filter(function (item) {  return item.cityId == id })
      },

      getSightsByCityIds: function (ids) {
        var context = this,
            result;
        result = Array.prototype.concat.apply([], ids.map(function (cityId) {
          return context.getSightsByCityId(cityId);
        }));

        console.log("Requested sights => ", result);

        return result;
      }
    };

    /* ReactSelectizeMixin */
    var ReactSelectizeMixin = React.createClass({
      _defaults: {
        valueField: "id",
        labelField: "name",
        searchField: "name",
        create: false
      },

      buildOptions: function () {
        var o = {},
            d = this._defaults;

        o.valueField = this.props.valueField || d.valueField;
        o.labelField = this.props.labelField || d.labelField;
        o.searchField = this.props.searchField || d.searchField;
        if(this.props.multiple || this.props.maxItems != undefined){
          // Selectize becomes 'multiple' when 'maxItems' is passed via settings
          o.maxItems = this.props.maxItems || null;
        }
        o.options = this.props.items || [];
        o.create = this.props.create || d.create;

        return o;
      },

      rebuildSelectize: function () {
        var selectId = "#" + this.props.selectId,
            $select = $(selectId),
            selectControl = $select[0] && $select[0].selectize,
            items = this.props.items;

        if(selectControl) {
          // rebuild
          selectControl.off();
          selectControl.clearOptions();
          selectControl.load(function (cb) { cb(items) });
        } else {
          // build new
          $select = $select.selectize(this.buildOptions());
          selectControl = $select[0].selectize;
        }

        selectControl.setValue(this.props.value);
        if(this.props.onChange){
          selectControl.on('change', this.props.onChange);
        }
      },

      componentDidMount: function () {
        this.rebuildSelectize();
      },

      componentDidUpdate: function () {
        this.rebuildSelectize();
      },

      render: function () {
        return <div class="control-group">
            <label for={this.props.selectId}>{this.props.label}</label>
            <select id={this.props.selectId} placeholder={this.props.placeholder}></select>
        </div>
      }
    });

    /* LocationPanel */
    var LocationPanel = React.createClass({

      getInitialState: function () {
        return {
          selectedCountryId: -1,
          countries: CountryService.getCountryList(),
          cities: []
        }
      },

      handleCountryChanged: function (value) {
        var countryId = Number(value[0]);
        this.setState({
          selectedCountryId: countryId,
          cities: CityService.getCitiesByCountryId(countryId)
        });
      },

      handleCityChanged: function (value) {
      console.log(value);
        var ids = value.map(function (id) { return Number(id); });

        this.setState({
          selectedCityIds: ids,
          sights: SightsService.getSightsByCityIds(ids)
        });
      },

      render: function () {
        return <div>
          <ReactSelectizeMixin
            items={this.state.countries}
            value={this.state.selectedCountryId}
            onChange={this.handleCountryChanged}
            selectId="select-country"
            placeholder="Pick a country.."
            label="Country:"
            />

          <ReactSelectizeMixin
            items={this.state.cities}
            value={this.state.selectedCityIds}
            selectId="select-cities"
            placeholder="Pick a city.."
            label="City:"
            multiple={true}
            onChange={this.handleCityChanged}
            />

          <ReactSelectizeMixin
            items={this.state.sights}
            selectId="select-sights"
            placeholder="Pick a sightseeing.."
            label="Sightseeings:"
            multiple={true}
            />
        </div>
      }
    });

    /* Render app */
    React.renderComponent(<LocationPanel />, document.getElementById('example'));
  </script>
</body>
</html>